<?php

namespace Front\AppBundle\Repository;

use DateTime;
use Doctrine\ORM\EntityRepository;
use Front\AppBundle\Entity\Application;
use Front\UserBundle\Entity\User;

/**
 * ApplicationConnectionStatisticsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ApplicationConnectionStatisticsRepository extends EntityRepository
{
    /**
     * Returns the ApplicationConnectionStatistics from today, for a specific user, application and profile
     * @param User $user
     * @param Application $application
     * @param $profile
     * @return array
     */
    public function findByUserApplicationProfileToday(User $user, Application $application, $profile) {
        return $this->createQueryBuilder("application_connection_statistics")
            ->where("application_connection_statistics.user = :user")
            ->setParameter("user", $user)
            ->andWhere("application_connection_statistics.application = :application")
            ->setParameter("application", $application)
            ->andWhere("application_connection_statistics.profileName = :profile")
            ->setParameter("profile", $profile)
            ->andWhere("application_connection_statistics.date BETWEEN :firstDate AND :lastDate")
            ->setParameter("firstDate", new DateTime((new DateTime())->format("Y-m-d")." 00:00:00"))
            ->setParameter("lastDate", new DateTime((new DateTime())->format("Y-m-d")." 23:59:59"))
            ->getQuery()
            ->getResult();
    }

    /**
     * Returns the number of users by months by application
     * @return array
     */
    public function getCountUserByApplication($month, $year) {
        return $this->createQueryBuilder("application_connection_statistics")
            ->select("COUNT(application_connection_statistics.user) as number_user, 
                        application.code as application_code")
            ->innerJoin("application_connection_statistics.application", "application")
            ->where("MONTH(application_connection_statistics.date) = :month")
            ->setParameter("month", $month)
            ->andWhere("YEAR(application_connection_statistics.date) = :year")
            ->setParameter("year", $year)
            ->groupBy("application_connection_statistics.application")
            ->orderBy("application.name")
            ->getQuery()
            ->getResult();
    }

    /**
     * Returns the values for $numberMonthsToReturn months for the browsers used in the app
     * @param $numberMonthsToReturn
     * @return array
     */
    public function getComparisonBrowser ($numberMonthsToReturn) {
        return $this->createQueryBuilder("application_connection_statistics")
            ->select("COUNT(application_connection_statistics.browser) as number_connection, 
                        application_connection_statistics.browser")
            ->where("application_connection_statistics.date > :date")
            ->setParameter("date", new DateTime('0:00 first day of -' . $numberMonthsToReturn . ' months'))
            ->groupBy("application_connection_statistics.browser")
            ->getQuery()
            ->getResult();
    }

    public function getCountByProfile(Application $application, $numberMonthToDisplay) {
        return $this->createQueryBuilder("application_connection_statistics")
            ->select("application_connection_statistics.profileName, COUNT(application_connection_statistics.profileName) as number_profile")
            ->where("application_connection_statistics.date > :date")
            ->setParameter("date", new DateTime('0:00 first day of -'.$numberMonthToDisplay.' months'))
            ->andWhere("application_connection_statistics.application = :application")
            ->setParameter("application", $application)
            ->groupBy("application_connection_statistics.profileName")
            ->getQuery()
            ->getResult();
    }
}
